
# CI/CD Pipeline for the abetworks crm Backend (NestJS)
# This workflow is triggered on pushes to the main branch that affect the /backend directory.

name: Deploy Backend

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  workflow_dispatch: # Allows manual triggering

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # In a real-world scenario, you would replace these placeholders with your actual
      # project ID, service account, and workload identity provider from your cloud provider.
      - name: Authenticate to Google Cloud
        id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: 'projects/YOUR_PROJECT_ID/locations/global/workloadIdentityPools/YOUR_POOL/providers/YOUR_PROVIDER'
          service_account: 'your-service-account@your-project-id.iam.gserviceaccount.com'

      - name: Install Backend Dependencies
        run: |
          cd backend
          npm ci

      - name: Run Backend Linter and Tests
        run: |
          cd backend
          npm run lint
          npm run test
          npm run test:e2e

      - name: Build Backend Application
        run: |
            cd backend
            npm run build

      - name: Build and Push Docker Image
        if: success()
        run: |
          docker build --tag="gcr.io/PROJECT_ID/abetworks-crm-backend:$GITHUB_SHA" ./backend
          docker push "gcr.io/PROJECT_ID/abetworks-crm-backend:$GITHUB_SHA"
      
      - name: Deploy to Cloud Run
        if: success()
        uses: 'google-github-actions/deploy-cloudrun@v2'
        with:
          service: 'abetworks-crm-backend'
          region: 'us-central1'
          image: 'gcr.io/PROJECT_ID/abetworks-crm-backend:$GITHUB_SHA'
          # Add other configurations like environment variables from secrets
